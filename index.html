<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Prevent zoom on input focus on mobile */
        @media screen and (max-width: 420px) {
            select, textarea, input[type="text"], [contenteditable] {
                font-size: 16px !important;
            }
        }
    </style>
    <title>Home Affordability Estimator</title>

    <style>
        /* ============================================================
           UNIVERSAL & MOBILE FIRST
           ============================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: auto;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f4f6fb;
            padding: 8px;
            color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
            user-select: none;
        }
        input {
            cursor: text;
            user-select: text;
        }
        button {
            cursor: pointer;
            user-select: none;
        }
        .step {
            user-select: text;
        }
        .section-box {
            user-select: text;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* ============================================================
           HEADERS
           ============================================================ */
        h1 {
            font-size: 6vw;
            font-weight: 800;
            text-align: center;
            margin-bottom: 0.5vh;
            color: #0b2345;
        }
        @media (min-width: 420px) {
            h1 {
                font-size: 26px;
            }
        }
        h2 {
            font-size: 4.2vw;
            font-weight: 700;
            margin-bottom: 8px;
        }
        @media (min-width: 420px) {
            h2 {
                font-size: 19px;
            }
        }
        p.sub {
            color: #6a7485;
            font-size: 4.2vw;
            margin-bottom: 12px;
        }
        @media (min-width: 420px) {
            p.sub {
                font-size: 19px;
            }
        }

        /* ============================================================
           STEP PANELS
           ============================================================ */
        .step {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: none;
        }
        .step.active { display: block; }

        /* ============================================================
           INPUTS
           ============================================================ */
        label {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 4px;
            display: block;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #d6d9e0;
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 8px;
        }
        @media (min-width: 420px) {
            input[type="text"] {
                font-size: 18px;
            }
        }
        input[type="text"]::placeholder {
            color: #9ca3af;
        }
        button {
            width: 100%;
            padding: 1.5vh;
            font-size: 4vw;
            font-weight: 700;
            border-radius: 10px;
            border: none;
            margin-top: 0.5vh;
            cursor: pointer;
        }
        @media (min-width: 420px) {
            button {
                padding: 15px;
                font-size: 18px;
            }
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-secondary {
            background: #f0f2f7;
            color: #0b2345;
        }

        /* ============================================================
           SUMMARY PAGE
           ============================================================ */

        .section-box {
            background: white;
            padding: 2.5vw;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-top: 0.5vh;
            overflow-y: auto;
        }
        @media (min-width: 420px) {
            .section-box {
                padding: 16px;
            }
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 1.2vh 0;
            font-size: 4.2vw;
        }
        @media (min-width: 420px) {
            .summary-row {
                font-size: 19px;
                margin: 12px 0;
            }
        }
        .summary-label {
            color: #6a7485;
        }
        .summary-value {
            font-weight: 800;
            min-width: 80px;
            max-width: 150px;
            display: inline-block;
            outline: none;
            text-align: right;
        }
        #purchaseBig,
        #sumLoan,
        #sumDown,
        #sumMonthly {
            text-align: right;
            max-width: 150px;
        }
        #purchaseBig:hover,
        #sumLoan:hover,
        #sumDown:hover,
        #sumMonthly:hover {
            color: inherit;
        }
        .summary-value[data-edit] {
            font-style: italic;
        }
        @media (hover: hover) and (pointer: fine) {
            .summary-value[data-edit]:hover {
                color: #2563eb;
            }
        }
        .summary-value[contenteditable="true"] {
            border-radius: 4px;
            padding: 2px 4px;
        }
        .summary-value[contenteditable="true"]:focus {
            outline: none;
            color: #2563eb;
        }
        .summary-row:has(.summary-value[contenteditable="true"]:focus) .summary-label {
            color: #2563eb;
        }
        .summary-value[contenteditable="true"] {
            -webkit-tap-highlight-color: transparent;
        }
        .dropdown-row span:last-child {
            font-weight: 800;
            min-width: 80px;
            max-width: 150px;
            display: inline-block;
            outline: none;
            text-align: right;
        }
        .dropdown-row span:last-child {
            font-style: italic;
        }
        @media (hover: hover) and (pointer: fine) {
            .dropdown-row span:last-child:hover {
                color: #2563eb;
            }
        }
        .dropdown-row span:last-child[contenteditable="true"] {
            border-radius: 4px;
            padding: 2px 4px;
        }
        .dropdown-row span:last-child[contenteditable="true"]:focus {
            outline: none;
            color: #2563eb;
        }
        .dropdown-row:has(span:last-child[contenteditable="true"]:focus) span:first-child {
            color: #2563eb;
        }
        .dropdown-row span:last-child[contenteditable="true"] {
            -webkit-tap-highlight-color: transparent;
        }

        hr {
            border: 0;
            border-bottom: 1px solid #e1e4ea;
            margin: 1vh 0;
        }

        /* Dropdown */
        .dropdown {
            margin-top: 0.5vh;
        }
        .dropdown button {
            background: #e9edf5;
            color: #0b2345;
            padding: 2vh 2vw;
            font-size: 3.8vw;
            -webkit-tap-highlight-color: transparent;
        }
        @media (min-width: 420px) {
            .dropdown button {
                padding: 12px;
                font-size: 16px;
            }
        }
        .dropdown-content {
            display: none;
            padding: 10px;
            background: #f9fbff;
            border-radius: 10px;
            margin-top: 6px;
            border: 1px solid #d9dee8;
        }
        .dropdown-row {
            display: flex;
            justify-content: space-between;
            margin: 1.2vh 0;
            font-size: 3.8vw;
        }
        @media (min-width: 420px) {
            .dropdown-row {
                font-size: 16px;
                margin: 8px 0;
            }
        }


        /* Footer */
        footer {
            text-align: center;
            font-size: 2.5vw;
            margin-top: 0.5vh;
            color: #6a7485;
            line-height: 1.4;
        }
        footer a {
            color: #2563eb;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
        }
        @media (min-width: 420px) {
            footer {
                font-size: 12px;
            }
        }

        /* Explanation Mode Button */
        .explanation-toggle {
            position: absolute;
            top: 5px;
            transform: translateY(-50%);
            right: 0;
            background: #e9edf5;
            color: #0b2345;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 9px;
            border: none;
            cursor: pointer;
            width: auto;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .explanation-toggle:hover {
            background: #d9dee8;
        }

        /* Refresh Button */
        .refresh-button {
            position: absolute;
            top: -10px;
            transform: translateY(-50%);
            left: 0;
            background: #e9edf5;
            color: #0b2345;
            padding: 6px 10px;
            font-size: 16px;
            border-radius: 9px;
            border: none;
            cursor: pointer;
            width: auto;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        .refresh-button:hover {
            background: #d9dee8;
        }

        /* Big number container for positioning */
        .big-number-container {
            position: relative;
            display: block;
            width: 100%;
            min-height: 3px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        /* Explanation text styles */
        .explanation-text {
            font-size: 15px;
            color: #4a5568;
            line-height: 1.7;
        }
        .explanation-label {
            font-weight: 700;
            color: #1a1a1a;
        }

        /* Hide elements in explanation mode */
        .hide-in-explanation {
            display: none;
        }

        /* Section box relative positioning for button */
        .section-box {
            position: relative;
        }

        /* Explanation dropdown styles */
        .explanation-section {
            margin-bottom: 24px;
        }
        .explanation-section h3 {
            font-size: 21px;
            font-weight: 700;
            margin-top: 14px;
            margin-bottom: 0;
            color: #0b2345;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        .explanation-section h3:hover {
            color: #2563eb;
        }
        .explanation-section h3:first-of-type {
            margin-top: 28px;
        }
        .explanation-section h3:not(:first-of-type) {
            margin-top: 20px;
        }
        .explanation-dropdown-content {
            display: none;
            padding-top: 8px;
        }

    </style>
</head>
<body>

<div class="container">

    <h1>Home Affordability Estimator</h1>

    <!-- ============================================================
        STEP 1: INCOME
        ============================================================ -->
    <div id="step1" class="step active">
        <p class="sub">Enter your monthly gross income before taxes and deductions.</p>

        <input id="incomeInput" type="text" inputmode="numeric" placeholder="$6,000">

        <button class="btn-primary" id="goToStep2">Continue</button>
    </div>

    <!-- ============================================================
        STEP 2: DEBT
        ============================================================ -->
    <div id="step2" class="step">
        <p class="sub">Enter your total monthly debt payments - the minimum amounts you pay each month on car loans, student loans, credit cards, etc.</p>

        <input id="debtInput" type="text" inputmode="numeric" placeholder="$500">

        <button class="btn-primary" id="goToSummary">See My Options</button>
        <button class="btn-secondary" id="backTo1">Back</button>
    </div>

    <!-- ============================================================
        SUMMARY PAGE
        ============================================================ -->
    <div id="summary" class="step">

        <!-- Click/Tap instruction and Definitions Button -->
        <div style="position: relative; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div id="clickTapText" style="font-size: 13px; font-style: italic; color: #6a7485;">
                Click italicized numbers to customize
            </div>
            <button class="explanation-toggle" id="explanationToggle">Definitions</button>
        </div>

        <!-- Loan Amount + Monthly Payment -->
        <div class="section-box">

            <div class="summary-row">
                <span class="summary-label">Purchase Price</span>
                <span id="purchaseBig" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Loan Amount</span>
                <span id="sumLoan" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Down Payment</span>
                <span id="sumDown" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Payment</span>
                <span id="sumMonthly" class="summary-value">$0</span>
            </div>

            <!-- DROPDOWN -->
            <div class="dropdown">
                <button id="toggleBreakdown">Show Payment Breakdown ▼</button>
                <div id="breakdownBox" class="dropdown-content">
                    <div class="dropdown-row">
                        <span>Principal + Interest  </span><span id="bdPI" class="summary-value" data-edit="pi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Property Taxes</span><span id="bdTaxes" class="summary-value" data-edit="taxes" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Homeowners Insurance  </span><span id="bdHOI" class="summary-value" data-edit="hoi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Private Mortgage Insurance  </span><span id="bdPMI" class="summary-value" data-edit="pmi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Homeowners Association Dues  </span><span id="bdHOA" class="summary-value" data-edit="hoa" data-type="currency">0</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; font-style: italic; color: #9ca3af;">
                        Monthly payment breakdown are estimates only
                    </div>
                </div>
            </div>

            <hr>

            <!-- Editable Variables -->
            <div class="summary-row">
                <span class="summary-label">Down Payment %  </span>
                <span class="summary-value" data-edit="downPct" data-type="percent">5</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Interest Rate  </span>
                <span class="summary-value" data-edit="interestRate" data-type="percent">6</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Loan Term        </span>
                <span class="summary-value" data-edit="termYears" data-type="years">30</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Income  </span>
                <span class="summary-value" data-edit="grossIncome" data-type="currency">0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Debt  </span>
                <span class="summary-value" data-edit="monthlyDebt" data-type="currency">0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Target Monthly Payment  </span>
                <span class="summary-value" data-edit="desiredPayment" data-type="currency">0</span>
            </div>

            <div style="padding-left: 20px; margin-top: -10px; margin-bottom: 10px;">
                <span id="budgetStatus" style="font-size: 12px; font-weight: 600; font-style: italic;"></span>
            </div>

            <!-- SUMMARY DROPDOWN -->
            <div class="dropdown">
                <button id="toggleSummary">Summarize the numbers ▼</button>
                <div id="summaryBox" class="dropdown-content">
                    <div id="budgetSummaryText" style="font-size: 15px; line-height: 1.6; color: #1a1a1a; padding: 5px 0;"></div>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <footer>
            Have questions or want to review your numbers?<br>
            Contact Cameron Webb<br>
            <a href="tel:8014724951">(801) 472 - 4951</a> | <a href="mailto:cameron.webb@houzd.com">cameron.webb@houzd.com</a>
        </footer>

    </div>

</div>


<script>
/* ============================================================
   STATE
   ============================================================ */
let state = {
    grossIncome: 0,
    monthlyDebt: 0,
    desiredPayment: 0,  // User's desired monthly payment for housing
    downPct: 5,
    interestRate: 6.125,
    termYears: 30,
    taxes: 0,  // Will be calculated dynamically as 0.5% of purchase price per year
    hoi: 0,  // Will be calculated dynamically as 0.35% of purchase price per year
    hoa: 0,
    pmi: 0,  // Will be calculated dynamically
    // Track if user manually edited these fields
    taxesManuallySet: false,
    hoiManuallySet: false,
    pmiManuallySet: false
};

// Store original values when user first enters calculator
let originalValues = {
    income: 0,
    debt: 0,
    desiredPayment: 0
};

/* UTILITIES */
function parseCurrency(str) { return Number(String(str).replace(/[$, ]/g, '')) || 0; }

// Format input as currency while typing
function formatCurrencyInput(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value) {
        value = parseInt(value, 10);
        input.value = "$" + value.toLocaleString();
    } else {
        input.value = '';
    }
}

// Format editable field based on type
function formatEditableInput(el, type, key) {
    let text = el.textContent.replace(/[^0-9.]/g, '');
    if (!text) {
        el.textContent = '';
        return;
    }
    
    const numValue = parseFloat(text) || 0;
    
    if (type === "currency") {
        el.textContent = "$" + Math.round(numValue).toLocaleString();
    } else if (type === "percent") {
        if (key === "downPct") {
            el.textContent = numValue.toFixed(1) + "%";
        } else if (key === "interestRate") {
            el.textContent = numValue.toFixed(3) + "%";
        } else if (key === "dtiPct") {
            el.textContent = numValue.toFixed(2) + "%";
        } else {
            el.textContent = numValue.toFixed(2) + "%";
        }
    } else if (type === "years") {
        el.textContent = Math.round(numValue) + " years";
    } else {
        el.textContent = numValue.toString();
    }
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function goToStep2Func() {
    const v = parseCurrency(incomeInput.value);
    // If no value entered, use default of 6000
    if (v <= 0) {
        state.grossIncome = 6000;
        incomeInput.value = "$6,000";
    } else {
        state.grossIncome = v;
    }

    step1.classList.remove("active");
    step2.classList.add("active");
}

goToStep2.onclick = goToStep2Func;

// Format income input as currency
incomeInput.addEventListener("input", () => formatCurrencyInput(incomeInput));
incomeInput.addEventListener("focus", () => {
    incomeInput.select();
});
incomeInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        goToStep2Func();
    }
});

// Autofocus income input when step1 becomes active
const observer1 = new MutationObserver(() => {
    if (step1.classList.contains("active")) {
        incomeInput.focus();
    }
});
observer1.observe(step1, { attributes: true, attributeFilter: ["class"] });
if (step1.classList.contains("active")) {
    incomeInput.focus();
}

backTo1.onclick = () => {
    step2.classList.remove("active");
    step1.classList.add("active");
};

function goToSummaryFunc() {
    const debtValue = parseCurrency(debtInput.value);
    // If no value entered, use default of 500
    if (debtValue < 0 || !debtInput.value.trim()) {
        state.monthlyDebt = 500;
        debtInput.value = "$500";
    } else {
        state.monthlyDebt = debtValue;
    }

    if (!state.grossIncome) {
        state.grossIncome = parseCurrency(incomeInput.value);
    }

    // Set initial desired payment at 36% DTI
    state.desiredPayment = (state.grossIncome * 0.36) - state.monthlyDebt;
    if (state.desiredPayment < 0) state.desiredPayment = 0;

    // Save original values when first entering calculator
    originalValues.income = state.grossIncome;
    originalValues.debt = state.monthlyDebt;
    originalValues.desiredPayment = state.desiredPayment;

    calculate();
    step2.classList.remove("active");
    summary.classList.add("active");
    
    // Format all editable fields immediately
    setTimeout(() => {
        document.querySelectorAll("[data-edit]").forEach(el => {
            const key = el.dataset.edit;
            const type = el.dataset.type || "currency";
            let numValue = 0;
            if (key === "grossIncome") numValue = state.grossIncome;
            else if (key === "monthlyDebt") numValue = state.monthlyDebt;
            else if (key === "downPct") numValue = state.downPct;
            else if (key === "interestRate") numValue = state.interestRate;
            else if (key === "termYears") numValue = state.termYears;
            else if (key === "desiredPayment") numValue = state.desiredPayment;
            else if (key === "taxes") numValue = state.taxes;
            else if (key === "hoi") numValue = state.hoi;
            else if (key === "hoa") numValue = state.hoa;
            else if (key === "pmi") numValue = state.pmi;
            else numValue = parseFloat(el.textContent.replace(/[^0-9.-]+/g, "")) || 0;
            
            if (type === "currency") {
                el.textContent = "$" + Math.round(numValue).toLocaleString();
            } else if (type === "percent") {
                if (key === "downPct") {
                    el.textContent = parseFloat(numValue).toFixed(1) + "%";
                } else if (key === "interestRate") {
                    el.textContent = parseFloat(numValue).toFixed(3) + "%";
                } else {
                    el.textContent = parseFloat(numValue).toFixed(2) + "%";
                }
            } else if (type === "years") {
                el.textContent = Math.round(numValue) + " years";
            }
        });
    }, 50);
}

goToSummary.onclick = goToSummaryFunc;

// Format debt input as currency
debtInput.addEventListener("input", () => formatCurrencyInput(debtInput));
debtInput.addEventListener("focus", () => {
    debtInput.select();
});
debtInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        goToSummaryFunc();
    }
});

// Autofocus debt input when step2 becomes active
const observer2 = new MutationObserver(() => {
    if (step2.classList.contains("active")) {
        debtInput.focus();
    }
});
observer2.observe(step2, { attributes: true, attributeFilter: ["class"] });

/* ============================================================
   CALCULATION
   ============================================================ */
function calculate(editedField = null) {
    const g = state.grossIncome;
    const debt = state.monthlyDebt;

    let monthlyPayment;
    let PI;
    let loan = 0;
    let purchase = 0;
    let downPayment = 0;

    const r = (state.interestRate / 100) / 12;
    const n = state.termYears * 12;
    const down = state.downPct / 100;

    // Determine if PMI should be applied (down payment < 20%)
    const needsPMI = state.downPct < 20;

    // Mark when user manually edits taxes, HOI, or PMI
    if (editedField === 'taxes') {
        state.taxesManuallySet = true;
    }
    if (editedField === 'hoi') {
        state.hoiManuallySet = true;
    }
    if (editedField === 'pmi') {
        state.pmiManuallySet = true;
    }

    // If user edited PI specifically, recalculate monthly payment and desired payment
    if (editedField === 'pi') {
        PI = state.pi;
        if (PI < 0) PI = 0;

        // Calculate loan from PI
        if (PI > 0 && r > 0) {
            loan = (PI * (Math.pow(1 + r, n) - 1)) / (r * Math.pow(1 + r, n));
        } else if (PI > 0) {
            loan = PI * n;
        }
        if (!isFinite(loan) || loan < 0) loan = 0;

        // Calculate purchase price
        purchase = loan > 0 ? loan / (1 - down) : 0;

        // Recalculate taxes, HOI, and PMI based on new purchase price (unless manually set)
        if (!state.taxesManuallySet) {
            state.taxes = purchase * 0.005 / 12;
        }
        if (!state.hoiManuallySet) {
            state.hoi = purchase * 0.0035 / 12;
        }
        if (!state.pmiManuallySet) {
            state.pmi = needsPMI ? (loan * 0.0035 / 12) : 0;
        }

        // Calculate new total monthly payment
        monthlyPayment = PI + state.taxes + state.hoi + state.hoa + state.pmi;

        // Update desired payment to match the new monthly payment
        state.desiredPayment = monthlyPayment;
    }
    // If user edited other breakdown items (taxes, hoi, hoa, pmi), keep monthly payment constant
    else if (editedField === 'taxes' || editedField === 'hoi' || editedField === 'hoa' || editedField === 'pmi') {
        // Keep the total monthly payment constant using desired payment
        monthlyPayment = state.desiredPayment;
        if (monthlyPayment < 0) monthlyPayment = 0;

        // Calculate PI by subtracting other costs from total monthly payment
        const otherCosts = state.taxes + state.hoi + state.hoa + state.pmi;
        PI = monthlyPayment - otherCosts;
        if (PI < 0) PI = 0;

        // Calculate loan from PI
        if (PI > 0 && r > 0) {
            loan = (PI * (Math.pow(1 + r, n) - 1)) / (r * Math.pow(1 + r, n));
        } else if (PI > 0) {
            loan = PI * n;
        }
        if (!isFinite(loan) || loan < 0) loan = 0;

        // Calculate purchase price
        purchase = loan > 0 ? loan / (1 - down) : 0;

        // Store PI in state
        state.pi = PI;
    }
    // If user edited desired payment
    else if (editedField === 'desiredPayment') {
        monthlyPayment = state.desiredPayment;
        if (monthlyPayment < 0) monthlyPayment = 0;

        // Iteratively calculate loan, taxes, HOI, and PMI (unless manually set)
        let tempLoan = 0;
        let tempPMI = state.pmiManuallySet ? state.pmi : 0;
        let tempTaxes = state.taxesManuallySet ? state.taxes : 0;
        let tempHOI = state.hoiManuallySet ? state.hoi : 0;
        let tempPurchase = 0;

        for (let i = 0; i < 10; i++) {
            const monthlyOther = tempTaxes + tempHOI + state.hoa + tempPMI;
            PI = monthlyPayment - monthlyOther;
            if (PI < 0) PI = 0;

            if (PI > 0 && r > 0) {
                tempLoan = (PI * (Math.pow(1 + r, n) - 1)) / (r * Math.pow(1 + r, n));
            } else if (PI > 0) {
                tempLoan = PI * n;
            }
            if (!isFinite(tempLoan) || tempLoan < 0) tempLoan = 0;

            // Calculate purchase price from loan
            tempPurchase = tempLoan > 0 ? tempLoan / (1 - down) : 0;

            // Calculate taxes only if not manually set
            if (!state.taxesManuallySet) {
                tempTaxes = tempPurchase * 0.005 / 12;
            }

            // Calculate HOI only if not manually set
            if (!state.hoiManuallySet) {
                tempHOI = tempPurchase * 0.0035 / 12;
            }

            // Calculate PMI only if not manually set
            if (!state.pmiManuallySet) {
                tempPMI = needsPMI ? (tempLoan * 0.0035 / 12) : 0;
            }
        }

        loan = tempLoan;
        purchase = tempPurchase;
        if (!state.taxesManuallySet) {
            state.taxes = tempTaxes;
        }
        if (!state.hoiManuallySet) {
            state.hoi = tempHOI;
        }
        if (!state.pmiManuallySet) {
            state.pmi = needsPMI ? (loan * 0.0035 / 12) : 0;
        }
        state.pi = PI;
    }
    // For all other fields (downPct, grossIncome, monthlyDebt, interestRate, termYears), use desired payment
    else {
        monthlyPayment = state.desiredPayment;
        if (monthlyPayment < 0) monthlyPayment = 0;

        // Iteratively calculate loan, taxes, HOI, and PMI (unless manually set)
        let tempLoan = 0;
        let tempPMI = state.pmiManuallySet ? state.pmi : 0;
        let tempTaxes = state.taxesManuallySet ? state.taxes : 0;
        let tempHOI = state.hoiManuallySet ? state.hoi : 0;
        let tempPurchase = 0;

        for (let i = 0; i < 10; i++) {
            const monthlyOther = tempTaxes + tempHOI + state.hoa + tempPMI;
            PI = monthlyPayment - monthlyOther;
            if (PI < 0) PI = 0;

            if (PI > 0 && r > 0) {
                tempLoan = (PI * (Math.pow(1 + r, n) - 1)) / (r * Math.pow(1 + r, n));
            } else if (PI > 0) {
                tempLoan = PI * n;
            }
            if (!isFinite(tempLoan) || tempLoan < 0) tempLoan = 0;

            // Calculate purchase price from loan
            tempPurchase = tempLoan > 0 ? tempLoan / (1 - down) : 0;

            // Calculate taxes only if not manually set
            if (!state.taxesManuallySet) {
                tempTaxes = tempPurchase * 0.005 / 12;
            }

            // Calculate HOI only if not manually set
            if (!state.hoiManuallySet) {
                tempHOI = tempPurchase * 0.0035 / 12;
            }

            // Calculate PMI only if not manually set
            if (!state.pmiManuallySet) {
                tempPMI = needsPMI ? (tempLoan * 0.0035 / 12) : 0;
            }
        }

        loan = tempLoan;
        purchase = tempPurchase;
        if (!state.taxesManuallySet) {
            state.taxes = tempTaxes;
        }
        if (!state.hoiManuallySet) {
            state.hoi = tempHOI;
        }
        if (!state.pmiManuallySet) {
            state.pmi = needsPMI ? (loan * 0.0035 / 12) : 0;
        }
        state.pi = PI;
    }

    // Store PI in state for reference
    state.pi = PI;

    // Calculate down payment from purchase price (purchase already calculated in branches above)
    downPayment = purchase * down;

    // Calculate overall DTI for budget status
    const totalDebt = monthlyPayment + debt;
    const overallDTI = g > 0 ? (totalDebt / g) * 100 : 0;

    // Display
    purchaseBig.textContent = "$" + Math.round(purchase).toLocaleString();
    sumLoan.textContent = "$" + Math.round(loan).toLocaleString();
    sumDown.textContent = "$" + Math.round(downPayment).toLocaleString();
    sumMonthly.textContent = "$" + Math.round(monthlyPayment).toLocaleString();

    // Update budget status display
    const budgetStatusEl = document.getElementById('budgetStatus');
    if (budgetStatusEl) {
        let statusText = '';
        let statusColor = '';

        if (overallDTI <= 28) {
            statusText = 'Excellent Budget';
            statusColor = '#1e40af'; // Dark Blue
        } else if (overallDTI <= 36) {
            statusText = 'Recommended Budget';
            statusColor = '#15803d'; // Dark Green
        } else if (overallDTI <= 43) {
            statusText = 'Tight Budget';
            statusColor = '#ea580c'; // Orange
        } else if (overallDTI <= 50) {
            statusText = 'Risky Budget';
            statusColor = '#b91c1c'; // Dark Red
        } else if (overallDTI <= 56.99) {
            statusText = 'Very Risky Budget';
            statusColor = '#b91c1c'; // Dark Red
        } else {
            statusText = 'Very Risky Budget';
            statusColor = '#b91c1c'; // Dark Red
        }

        // Add DTI percentage in parentheses
        statusText += ` (${overallDTI.toFixed(2)}% DTI)`;

        budgetStatusEl.textContent = statusText;
        budgetStatusEl.style.color = statusColor;
    }

    // Update budget summary text in dropdown
    const budgetSummaryTextEl = document.getElementById('budgetSummaryText');
    if (budgetSummaryTextEl) {
        // Calculate remaining monthly budget
        const remainingBudget = g - totalDebt;

        // Determine status text and color based on DTI
        let statusText = '';
        let statusColor = '';
        let statusPrefix = 'This is';

        if (overallDTI <= 28) {
            statusText = 'an excellent budget';
            statusColor = '#1e40af'; // Dark Blue
        } else if (overallDTI <= 36) {
            statusText = 'a recommended budget';
            statusColor = '#15803d'; // Dark Green
        } else if (overallDTI <= 43) {
            statusText = 'a tight budget';
            statusColor = '#ea580c'; // Orange
            statusPrefix = 'This could be';
        } else if (overallDTI <= 50) {
            statusText = 'a risky budget';
            statusColor = '#b91c1c'; // Dark Red
            statusPrefix = 'This could be';
        } else if (overallDTI <= 56.99) {
            statusText = 'a very risky budget';
            statusColor = '#b91c1c'; // Dark Red
            statusPrefix = 'This could be';
        } else {
            statusText = 'a very risky budget';
            statusColor = '#b91c1c'; // Dark Red
        }

        // Build the dynamic summary text with HTML for bold numbers and colored status
        budgetSummaryTextEl.innerHTML = `With a monthly income of <strong>$${Math.round(g).toLocaleString()}</strong>, debt of <strong>$${Math.round(debt).toLocaleString()}</strong>, and a housing payment of <strong>$${Math.round(monthlyPayment).toLocaleString()}</strong>, your debt-to-income ratio is <strong>${overallDTI.toFixed(2)}%</strong>.<br><br>This budget supports a <strong>$${Math.round(purchase).toLocaleString()}</strong> home with a <strong>${state.downPct.toFixed(1)}%</strong> (<strong>$${Math.round(downPayment).toLocaleString()}</strong>) down payment, <strong>${state.interestRate.toFixed(3)}%</strong> interest rate, and a <strong>${state.termYears}</strong> year term.<br><br>This leaves <strong>$${Math.round(remainingBudget).toLocaleString()}</strong> per month for taxes, other expenses, and savings.<br><br><strong style="font-style: italic; color: ${statusColor};">${statusPrefix} ${statusText}.</strong>`;
    }

    // Update breakdown if not currently editing
    if (document.activeElement.id !== 'bdPI') {
        document.getElementById('bdPI').textContent = "$" + Math.round(PI).toLocaleString();
    }
    if (document.activeElement.id !== 'bdTaxes') {
        document.getElementById('bdTaxes').textContent = "$" + Math.round(state.taxes).toLocaleString();
    }
    if (document.activeElement.id !== 'bdHOI') {
        document.getElementById('bdHOI').textContent = "$" + Math.round(state.hoi).toLocaleString();
    }
    if (document.activeElement.id !== 'bdHOA') {
        document.getElementById('bdHOA').textContent = "$" + Math.round(state.hoa).toLocaleString();
    }
    if (document.activeElement.id !== 'bdPMI') {
        document.getElementById('bdPMI').textContent = "$" + Math.round(state.pmi).toLocaleString();
    }

    // Update editable fields if not currently editing them
    updateEditableValue('[data-edit="grossIncome"]', g, "currency", "grossIncome");
    updateEditableValue('[data-edit="monthlyDebt"]', debt, "currency", "monthlyDebt");
    updateEditableValue('[data-edit="downPct"]', state.downPct, "percent", "downPct");
    updateEditableValue('[data-edit="interestRate"]', state.interestRate, "percent", "interestRate");
    updateEditableValue('[data-edit="termYears"]', state.termYears, "years", "termYears");
    updateEditableValue('[data-edit="desiredPayment"]', state.desiredPayment, "currency", "desiredPayment");
}

// Helper function to update editable values without disrupting editing
function updateEditableValue(selector, value, type, key) {
    const el = document.querySelector(selector);
    if (el && document.activeElement !== el) {
        if (type === "currency") {
            el.textContent = "$" + Math.round(value).toLocaleString();
        } else if (type === "percent") {
            if (key === "downPct") {
                el.textContent = parseFloat(value).toFixed(1) + "%";
            } else if (key === "interestRate") {
                el.textContent = parseFloat(value).toFixed(3) + "%";
            } else if (key === "dtiPct") {
                el.textContent = parseFloat(value).toFixed(2) + "%";
            } else {
                el.textContent = parseFloat(value).toFixed(2) + "%";
            }
        } else if (type === "years") {
            el.textContent = Math.round(value) + " years";
        }
    }
}

/* ============================================================
   DROPDOWN
   ============================================================ */
toggleBreakdown.onclick = () => {
    const box = breakdownBox;
    const visible = box.style.display === "block";
    box.style.display = visible ? "none" : "block";
    toggleBreakdown.textContent = visible
        ? "Show Payment Breakdown ▼"
        : "Hide Payment Breakdown ▲";
    toggleBreakdown.blur();
};

/* ============================================================
   SUMMARY DROPDOWN
   ============================================================ */
toggleSummary.onclick = () => {
    const box = summaryBox;
    const visible = box.style.display === "block";
    box.style.display = visible ? "none" : "block";
    toggleSummary.textContent = visible
        ? "Summarize the numbers ▼"
        : "Summarize the numbers ▲";
    toggleSummary.blur();
};

/* ============================================================
   INLINE EDITING
   ============================================================ */
function setupEditableFields() {
    document.querySelectorAll("[data-edit]").forEach(el => {
        if (el.hasAttribute('data-setup')) return;
        el.setAttribute('data-setup', 'true');
        el.setAttribute("contenteditable", "true");
        el.setAttribute("inputmode", "decimal");

        const key = el.dataset.edit;
        const type = el.dataset.type || "currency";
        let originalValue = parseFloat(el.textContent.replace(/[^0-9.-]+/g, "")) || 0;
        
        el.addEventListener("focus", function() {
            originalValue = parseFloat(this.textContent.replace(/[^0-9.-]+/g, "")) || 0;
            let text = this.textContent.replace(/[^0-9.]/g, '');
            let formattedText = '';

            if (type === "percent") {
                const numValue = parseFloat(text) || 0;
                if (key === "downPct") {
                    formattedText = numValue.toFixed(1) + "%";
                } else if (key === "interestRate") {
                    formattedText = numValue.toFixed(3) + "%";
                } else if (key === "dtiPct") {
                    formattedText = numValue.toFixed(2) + "%";
                } else {
                    formattedText = numValue.toString() + "%";
                }
            } else if (type === "currency") {
                const numValue = parseFloat(text) || 0;
                formattedText = "$" + numValue.toString();
            } else if (type === "years") {
                const numValue = parseFloat(text) || 0;
                formattedText = numValue.toString() + " years";
            } else {
                const numValue = parseFloat(text) || 0;
                formattedText = numValue.toString();
            }

            this.textContent = formattedText;

            setTimeout(() => {
                const range = document.createRange();
                const sel = window.getSelection();
                const textNode = this.firstChild;
                if (textNode) {
                    // Position cursor after prefix ($ sign) or at start
                    const startPos = type === "currency" ? 1 : 0;
                    range.setStart(textNode, startPos);

                    // Select to before suffix (%, years) or end
                    let endPos = formattedText.length;
                    if (type === "percent") {
                        endPos = formattedText.indexOf('%');
                    } else if (type === "years") {
                        endPos = formattedText.indexOf(' years');
                    }
                    range.setEnd(textNode, endPos);

                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 0);
        });
        
        el.addEventListener("input", function(e) {
            let text = this.textContent;
            let cleaned = text.replace(/[^0-9.]/g, '');
            const parts = cleaned.split('.');
            let finalText = '';

            if (parts.length === 0) {
                finalText = '';
            } else if (parts.length === 1) {
                finalText = parts[0] || '';
                if (text.trim().replace(/[^0-9.]/g, '').endsWith('.')) {
                    finalText += '.';
                }
            } else {
                finalText = parts[0] || '';
                let decimals = parts.slice(1).join('');

                if (key === "downPct") {
                    if (decimals.length > 1) decimals = decimals.substring(0, 1);
                } else if (key === "interestRate") {
                    if (decimals.length > 3) decimals = decimals.substring(0, 3);
                } else if (key === "dtiPct") {
                    if (decimals.length > 2) decimals = decimals.substring(0, 2);
                }

                finalText += '.' + decimals;
            }

            // Apply digit limits based on field type
            const integerPart = finalText.split('.')[0];
            const decimalPart = finalText.includes('.') ? finalText.split('.')[1] : '';

            // Define max digits for each field (total including integer and decimal)
            let maxIntegerDigits = 5; // default
            let maxDecimalDigits = 0;

            if (key === "pi") {
                maxIntegerDigits = 5; // max 99,999
            } else if (key === "taxes") {
                maxIntegerDigits = 4; // max 9,999
            } else if (key === "hoi") {
                maxIntegerDigits = 4; // max 9,999
            } else if (key === "hoa") {
                maxIntegerDigits = 4; // max 9,999
            } else if (key === "pmi") {
                maxIntegerDigits = 4; // max 9,999
            } else if (key === "downPct") {
                maxIntegerDigits = 2; // max 99.9%
                maxDecimalDigits = 1;
            } else if (key === "interestRate") {
                maxIntegerDigits = 2; // max 99.999%
                maxDecimalDigits = 3;
            } else if (key === "termYears") {
                maxIntegerDigits = 3; // max 999 years
            } else if (key === "grossIncome") {
                maxIntegerDigits = 5; // max 99,999
            } else if (key === "monthlyDebt") {
                maxIntegerDigits = 5; // max 99,999
            } else if (key === "dtiPct") {
                maxIntegerDigits = 2; // max 99.99%
                maxDecimalDigits = 2;
            }

            // Limit integer part
            let limitedInteger = integerPart.substring(0, maxIntegerDigits);

            // Reconstruct finalText with limits
            if (decimalPart && maxDecimalDigits > 0) {
                finalText = limitedInteger + '.' + decimalPart.substring(0, maxDecimalDigits);
            } else if (finalText.includes('.') && maxDecimalDigits > 0) {
                finalText = limitedInteger + '.';
            } else {
                finalText = limitedInteger;
            }

            // Add suffix/prefix based on type
            if (type === "currency") {
                finalText = "$" + finalText;
            } else if (type === "percent") {
                finalText = finalText + "%";
            } else if (type === "years") {
                finalText = finalText + " years";
            }

            if (finalText !== text) {
                const sel = window.getSelection();
                let cursorPos = finalText.length;
                if (sel.rangeCount > 0) {
                    try {
                        const range = sel.getRangeAt(0);
                        if (range.startContainer === this || range.startContainer.parentNode === this) {
                            cursorPos = range.startOffset;

                            // Adjust cursor position based on where numbers are
                            const numStart = type === "currency" ? 1 : 0;
                            const oldCleaned = text.replace(/[^0-9.]/g, '');
                            const newCleaned = finalText.replace(/[^0-9.]/g, '');

                            if (oldCleaned.includes('.') !== newCleaned.includes('.')) {
                                cursorPos = numStart + newCleaned.indexOf('.') + 1;
                            } else {
                                // Keep cursor in number portion
                                cursorPos = Math.max(numStart, Math.min(cursorPos, numStart + newCleaned.length));
                            }
                        }
                    } catch(e) {}
                }

                this.textContent = finalText;

                setTimeout(() => {
                    try {
                        const range = document.createRange();
                        const sel2 = window.getSelection();
                        const textNode = this.firstChild || this;
                        if (textNode) {
                            const pos = Math.min(cursorPos, finalText.length);
                            range.setStart(textNode, pos);
                            range.setEnd(textNode, pos);
                            sel2.removeAllRanges();
                            sel2.addRange(range);
                        }
                    } catch(e) {
                        const range = document.createRange();
                        const sel2 = window.getSelection();
                        range.selectNodeContents(this);
                        range.collapse(false);
                        sel2.removeAllRanges();
                        sel2.addRange(range);
                    }
                }, 0);
            }
        });
        
        let isEnterPressed = false;

        el.addEventListener("blur", function() {
            // Only process blur if it wasn't triggered by Enter key
            if (!isEnterPressed) {
                finishEditing(this, key, type);
            }
            isEnterPressed = false;
        });

        el.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                isEnterPressed = true;

                // Process the edit
                let text = this.textContent.replace(/[^0-9.-]+/g, "");
                let numValue = parseFloat(text) || 0;

                // Prevent negative numbers
                if (numValue < 0) numValue = 0;

                // Apply max limits
                if (key === "pi" && numValue > 99999) numValue = 99999;
                else if (key === "taxes" && numValue > 9999) numValue = 9999;
                else if (key === "hoi" && numValue > 9999) numValue = 9999;
                else if (key === "hoa" && numValue > 9999) numValue = 9999;
                else if (key === "pmi" && numValue > 9999) numValue = 9999;
                else if (key === "downPct" && numValue > 50.0) numValue = 50.0;
                else if (key === "interestRate" && numValue > 20.0) numValue = 20.0;
                else if (key === "termYears" && numValue > 50) numValue = 50;
                else if (key === "grossIncome" && numValue > 99999) numValue = 99999;
                else if (key === "monthlyDebt" && numValue > 99999) numValue = 99999;
                else if (key === "desiredPayment") {
                    // Cap desired payment at 100% DTI
                    const maxPayment = (state.grossIncome * 1.00) - state.monthlyDebt;
                    if (numValue > maxPayment) numValue = Math.max(0, maxPayment);
                    if (numValue > 99999) numValue = 99999;
                }

                state[key] = numValue;
                calculate(key);
                formatEditableInput(this, type, key);

                // Blur to remove focus
                this.blur();

                // Force focus to body to ensure no element retains focus
                document.body.focus();

            } else if (e.key === "Escape") {
                e.preventDefault();
                this.textContent = originalValue.toString();
                this.blur();
            }
        });
    });
}

function finishEditing(el, key, type) {
    let text = el.textContent.replace(/[^0-9.-]+/g, "");
    let numValue = parseFloat(text) || 0;

    // Prevent negative numbers
    if (numValue < 0) {
        numValue = 0;
    }

    // Apply max limits
    if (key === "pi" && numValue > 99999) numValue = 99999;
    else if (key === "taxes" && numValue > 9999) numValue = 9999;
    else if (key === "hoi" && numValue > 9999) numValue = 9999;
    else if (key === "hoa" && numValue > 9999) numValue = 9999;
    else if (key === "pmi" && numValue > 9999) numValue = 9999;
    else if (key === "downPct" && numValue > 50.0) numValue = 50.0;
    else if (key === "interestRate" && numValue > 20.0) numValue = 20.0;
    else if (key === "termYears" && numValue > 50) numValue = 50;
    else if (key === "grossIncome" && numValue > 99999) numValue = 99999;
    else if (key === "monthlyDebt" && numValue > 99999) numValue = 99999;
    else if (key === "desiredPayment") {
        // Cap desired payment at 100% DTI
        const maxPayment = (state.grossIncome * 1.00) - state.monthlyDebt;
        if (numValue > maxPayment) numValue = Math.max(0, maxPayment);
        if (numValue > 99999) numValue = 99999;
    }

    state[key] = numValue;

    // Recalculate based on what was edited
    calculate(key);

    formatEditableInput(el, type, key);

    // Blur the element and move focus to body to clear the blue outline
    el.blur();

    // Force focus to body to ensure no element retains focus
    document.body.focus();
}

// Setup editable fields on page load
setupEditableFields();

// Allow clicking anywhere to blur/submit editable fields
document.addEventListener('mousedown', function(e) {
    // Allow clicking on inputs, buttons, and contenteditable elements
    if (e.target.hasAttribute('contenteditable') ||
        e.target.tagName === 'INPUT' ||
        e.target.tagName === 'BUTTON') {
        return;
    }

    // If user clicks anywhere else, blur the active element if it's contenteditable
    if (document.activeElement && document.activeElement.hasAttribute('contenteditable')) {
        document.activeElement.blur();
    }
});

// Re-setup after calculate() updates the DOM
const originalCalculate = calculate;
calculate = function(editedField) {
    originalCalculate(editedField);
    setTimeout(() => {
        document.querySelectorAll("[data-edit]").forEach(el => {
            if (!el.hasAttribute('data-setup')) {
                setupEditableFields();
            }
        });
    }, 10);
};

/* ============================================================
   EXPLANATION MODE
   ============================================================ */
let explanationMode = false;

const explanations = {
    homeAffordability: {
        label: "Purchase Price",
        text: "The maximum home price you can afford based on your income and debts."
    },
    loanAmount: {
        label: "Loan Amount",
        text: "The total amount you'll borrow from a lender to purchase the home."
    },
    downPayment: {
        label: "Down Payment",
        text: "The upfront cash payment you make toward the purchase price."
    },
    monthlyPayment: {
        label: "Monthly Payment",
        text: "Your total monthly payment including principal, interest, taxes, and insurance."
    },
    principal: {
        label: "Principal",
        text: "The portion of your monthly payment that reduces your loan balance."
    },
    interest: {
        label: "Interest",
        text: "The portion of your monthly payment that covers the cost of borrowing."
    },
    propertyTaxes: {
        label: "Property Taxes",
        text: "Monthly property taxes paid to your local government."
    },
    homeownersInsurance: {
        label: "Homeowners Insurance",
        text: "Monthly insurance premium to protect your home and belongings."
    },
    hoaDues: {
        label: "Homeowners Association Dues",
        text: "Monthly fee for shared amenities and community maintenance."
    },
    pmi: {
        label: "Private Mortgage Insurance",
        text: "Required insurance when your down payment is less than 20%."
    },
    interestRate: {
        label: "Interest Rate",
        text: "The annual cost of borrowing, expressed as a percentage of your loan."
    },
    loanTerm: {
        label: "Loan Term",
        text: "The number of years you have to repay the mortgage loan in full."
    },
    monthlyIncome: {
        label: "Monthly Income",
        text: "Your total monthly income before any taxes or deductions."
    },
    monthlyDebt: {
        label: "Monthly Debt",
        text: "All recurring monthly debt payments including car loans and credit cards."
    },
    desiredPayment: {
        label: "Desired Monthly Payment",
        text: "The total amount you want to spend on housing each month."
    },
    dti: {
        label: "Debt-to-Income Ratio",
        text: "The percentage of your gross monthly income used to pay all debts."
    }
};

function toggleExplanationMode() {
    explanationMode = !explanationMode;
    const button = document.getElementById('explanationToggle');
    const dropdown = document.querySelector('.dropdown');
    const editNote = document.querySelector('[style*="text-align: center"]');
    const backBtn = document.getElementById('backBtn');
    const clickTapText = document.getElementById('clickTapText');

    if (explanationMode) {
        button.textContent = 'Calculator';
        button.style.top = '5px';
        button.style.transform = 'translateY(-50%)';

        // Hide Click/Tap instruction text in explanation mode
        if (clickTapText) {
            clickTapText.style.display = 'none';
            // Also hide the parent container's margin since only the button remains
            const parentContainer = clickTapText.parentElement;
            if (parentContainer) {
                parentContainer.style.marginBottom = '0';
            }
        }

        // Get all summary rows in the section-box
        const sectionBox = document.querySelector('.section-box');

        // Add top margin to move content down 32px
        sectionBox.style.marginTop = '32px';

        // Calculate current values for display
        const g = state.grossIncome;
        const debt = state.monthlyDebt;
        const dti = state.dtiPct / 100;
        const down = state.downPct / 100;
        const r = (state.interestRate / 100) / 12;
        const n = state.termYears * 12;
        const needsPMI = state.downPct < 20;

        let monthlyPayment = (g * dti) - debt;
        if (monthlyPayment < 0) monthlyPayment = 0;

        let tempLoan = 0;
        let tempPMI = 0;
        let tempTaxes = 0;
        let tempPurchase = 0;
        let PI = 0;

        for (let i = 0; i < 10; i++) {
            const monthlyOther = tempTaxes + state.hoi + state.hoa + tempPMI;
            PI = monthlyPayment - monthlyOther;
            if (PI < 0) PI = 0;

            if (PI > 0 && r > 0) {
                tempLoan = (PI * (Math.pow(1 + r, n) - 1)) / (r * Math.pow(1 + r, n));
            } else if (PI > 0) {
                tempLoan = PI * n;
            }
            if (!isFinite(tempLoan) || tempLoan < 0) tempLoan = 0;

            tempPurchase = tempLoan > 0 ? tempLoan / (1 - down) : 0;
            tempTaxes = tempPurchase * 0.005 / 12;
            tempPMI = needsPMI ? (tempLoan * 0.0035 / 12) : 0;
        }

        const purchase = tempPurchase;
        const loan = tempLoan;
        const downPayment = purchase * down;
        const principal = PI;
        const interest = PI; // This is combined P+I for now

        // Build new HTML with all explanations as dropdown sections
        sectionBox.innerHTML = `
            <div class="explanation-section">
                <h3 id="loanDefHeader">Loan Definitions ▼</h3>
                <div id="loanDefContent" class="explanation-dropdown-content">
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.homeAffordability.label}</span> - ${explanations.homeAffordability.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.loanAmount.label}</span> - ${explanations.loanAmount.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.downPayment.label}</span> - ${explanations.downPayment.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.interestRate.label}</span> - ${explanations.interestRate.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.loanTerm.label}</span> - ${explanations.loanTerm.text}</span>
                    </div>
                </div>
            </div>

            <div class="explanation-section">
                <h3 id="paymentDefHeader">Monthly Payment Definitions ▼</h3>
                <div id="paymentDefContent" class="explanation-dropdown-content">
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.monthlyPayment.label}</span> - ${explanations.monthlyPayment.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.principal.label}</span> - ${explanations.principal.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.interest.label}</span> - ${explanations.interest.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.propertyTaxes.label}</span> - ${explanations.propertyTaxes.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.homeownersInsurance.label}</span> - ${explanations.homeownersInsurance.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.pmi.label}</span> - ${explanations.pmi.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.hoaDues.label}</span> - ${explanations.hoaDues.text}</span>
                    </div>
                </div>
            </div>

            <div class="explanation-section">
                <h3 id="incomeDefHeader">Income Definitions ▼</h3>
                <div id="incomeDefContent" class="explanation-dropdown-content">
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.monthlyIncome.label}</span> - ${explanations.monthlyIncome.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.monthlyDebt.label}</span> - ${explanations.monthlyDebt.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.desiredPayment.label}</span> - ${explanations.desiredPayment.text}</span>
                    </div>
                    <div class="summary-row" style="padding-left: 20px;">
                        <span class="explanation-text"><span class="explanation-label">${explanations.dti.label}</span> - ${explanations.dti.text}</span>
                    </div>
                </div>
            </div>
        `;

        // Setup dropdown toggles
        const loanDefHeader = document.getElementById('loanDefHeader');
        const loanDefContent = document.getElementById('loanDefContent');
        const paymentDefHeader = document.getElementById('paymentDefHeader');
        const paymentDefContent = document.getElementById('paymentDefContent');
        const incomeDefHeader = document.getElementById('incomeDefHeader');
        const incomeDefContent = document.getElementById('incomeDefContent');

        loanDefHeader.onclick = () => {
            const visible = loanDefContent.style.display === "block";
            loanDefContent.style.display = visible ? "none" : "block";
            loanDefHeader.textContent = visible ? "Loan Definitions ▼" : "Loan Definitions ▲";
            loanDefHeader.style.color = visible ? "#0b2345" : "#2563eb";
            loanDefHeader.blur();
        };

        paymentDefHeader.onclick = () => {
            const visible = paymentDefContent.style.display === "block";
            paymentDefContent.style.display = visible ? "none" : "block";
            paymentDefHeader.textContent = visible ? "Monthly Payment Definitions ▼" : "Monthly Payment Definitions ▲";
            paymentDefHeader.style.color = visible ? "#0b2345" : "#2563eb";
            paymentDefHeader.blur();
        };

        incomeDefHeader.onclick = () => {
            const visible = incomeDefContent.style.display === "block";
            incomeDefContent.style.display = visible ? "none" : "block";
            incomeDefHeader.textContent = visible ? "Income Definitions ▼" : "Income Definitions ▲";
            incomeDefHeader.style.color = visible ? "#0b2345" : "#2563eb";
            incomeDefHeader.blur();
        };

    } else {
        button.textContent = 'Definitions';
        button.style.top = '5px';
        button.style.transform = 'translateY(-50%)';

        // Show Click/Tap instruction text when leaving explanation mode
        if (clickTapText) {
            clickTapText.style.display = 'block';
            // Restore the parent container's margin
            const parentContainer = clickTapText.parentElement;
            if (parentContainer) {
                parentContainer.style.marginBottom = '15px';
            }
        }

        // Restore numbers - rebuild the entire section-box with original structure
        const sectionBox = document.querySelector('.section-box');

        // Restore section-box top margin
        sectionBox.style.marginTop = '';
        sectionBox.innerHTML = `
            <div class="summary-row">
                <span class="summary-label">Purchase Price</span>
                <span id="purchaseBig" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Loan Amount</span>
                <span id="sumLoan" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Down Payment</span>
                <span id="sumDown" class="summary-value">$0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Payment</span>
                <span id="sumMonthly" class="summary-value">$0</span>
            </div>

            <!-- DROPDOWN -->
            <div class="dropdown">
                <button id="toggleBreakdown">Show Payment Breakdown ▼</button>
                <div id="breakdownBox" class="dropdown-content">
                    <div class="dropdown-row">
                        <span>Principal + Interest  </span><span id="bdPI" class="summary-value" data-edit="pi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Property Taxes</span><span id="bdTaxes" class="summary-value" data-edit="taxes" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Homeowners Insurance  </span><span id="bdHOI" class="summary-value" data-edit="hoi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Private Mortgage Insurance  </span><span id="bdPMI" class="summary-value" data-edit="pmi" data-type="currency">0</span>
                    </div>
                    <div class="dropdown-row">
                        <span>Homeowners Association Dues  </span><span id="bdHOA" class="summary-value" data-edit="hoa" data-type="currency">0</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; font-style: italic; color: #9ca3af;">
                        Monthly payment breakdown are estimates only
                    </div>
                </div>
            </div>

            <hr>

            <!-- Editable Variables -->
            <div class="summary-row">
                <span class="summary-label">Down Payment %  </span>
                <span class="summary-value" data-edit="downPct" data-type="percent">5</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Interest Rate  </span>
                <span class="summary-value" data-edit="interestRate" data-type="percent">6</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Loan Term        </span>
                <span class="summary-value" data-edit="termYears" data-type="years">30</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Income  </span>
                <span class="summary-value" data-edit="grossIncome" data-type="currency">0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Monthly Debt  </span>
                <span class="summary-value" data-edit="monthlyDebt" data-type="currency">0</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Target Monthly Payment  </span>
                <span class="summary-value" data-edit="desiredPayment" data-type="currency">0</span>
            </div>

            <div style="padding-left: 20px; margin-top: -10px; margin-bottom: 10px;">
                <span id="budgetStatus" style="font-size: 12px; font-weight: 600; font-style: italic;"></span>
            </div>

            <!-- SUMMARY DROPDOWN -->
            <div class="dropdown">
                <button id="toggleSummary">Summarize the numbers ▼</button>
                <div id="summaryBox" class="dropdown-content">
                    <div id="budgetSummaryText" style="font-size: 15px; line-height: 1.6; color: #1a1a1a; padding: 5px 0;"></div>
                </div>
            </div>
        `;

        // Re-setup dropdown functionality
        const toggleBreakdownBtn = document.getElementById('toggleBreakdown');
        const breakdownBox = document.getElementById('breakdownBox');
        toggleBreakdownBtn.onclick = () => {
            const visible = breakdownBox.style.display === "block";
            breakdownBox.style.display = visible ? "none" : "block";
            toggleBreakdownBtn.textContent = visible
                ? "Show Payment Breakdown ▼"
                : "Hide Payment Breakdown ▲";
        };

        // Setup summary dropdown functionality
        const toggleSummaryBtn = document.getElementById('toggleSummary');
        const summaryBox = document.getElementById('summaryBox');
        toggleSummaryBtn.onclick = () => {
            const visible = summaryBox.style.display === "block";
            summaryBox.style.display = visible ? "none" : "block";
            toggleSummaryBtn.textContent = visible
                ? "Summarize the numbers ▼"
                : "Summarize the numbers ▲";
        };

        // Restore numbers
        calculate();

        // Re-setup editable fields
        setTimeout(() => {
            setupEditableFields();
        }, 100);
    }
}

document.getElementById('explanationToggle').addEventListener('click', toggleExplanationMode);
</script>

</body>
</html>
